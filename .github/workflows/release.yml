name: Cross-Platform Build and Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      # --- ANDROID NDK ---
      - name: Install Android NDK
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
          unzip -qq android-ndk-r26b-linux.zip
          echo "$PWD/android-ndk-r26b/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      - name: Build Binaries
        run: |
          mkdir -p bin

          # Linux AMD64
          GOOS=linux GOARCH=amd64 go build -o bin/app-linux-amd64 main.go

          # Linux ARM64
          GOOS=linux GOARCH=arm64 go build -o bin/app-linux-arm64 main.go

          # Windows AMD64
          GOOS=windows GOARCH=amd64 go build -o bin/app-windows-amd64.exe main.go

          # Android ARM64 (using NDK)
          export CC=aarch64-linux-android21-clang
          CGO_ENABLED=1 GOOS=android GOARCH=arm64 go build -o bin/app-android-arm64 main.go

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            bin/*
          generate_release_notes: true
